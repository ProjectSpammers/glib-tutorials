<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GStreamer Receiver (TURN Enabled)</title>
    <style>
        body { background: #121212; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        video { width: 80%; background: #000; border: 1px solid #444; }
        textarea { width: 80%; height: 80px; background: #222; color: #0f0; border: 1px solid #555; font-family: monospace; }
        button { padding: 15px 30px; font-size: 16px; margin: 10px; cursor: pointer; background: #2196f3; color: white; border: none; font-weight: bold;}
        .status { color: #ff9800; font-weight: bold; margin: 10px; }
    </style>
</head>
<body>

    <h2>1. Video Stream</h2>
    <video id="remoteVideo" autoplay playsinline controls muted></video>
    <div id="status" class="status">Waiting for Offer...</div>

    <h3>2. Paste Offer Here</h3>
    <textarea id="offerInput" placeholder='Paste {"type":"offer"...} here'></textarea>

    <button onclick="handleOffer()">ACCEPT & GENERATE ANSWER</button>

    <h3>3. Copy this Answer (It will appear INSTANTLY)</h3>
    <textarea id="answerOutput" readonly placeholder="Answer will appear here immediately..."></textarea>
    <button onclick="navigator.clipboard.writeText(document.getElementById('answerOutput').value)">Copy to Clipboard</button>

    <script>
        // GÜNCELLEME: Metered.ca TURN sunucuları eklendi
        const pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: "stun:stun.relay.metered.ca:80",
                },
                {
                    urls: "turn:standard.relay.metered.ca:80",
                    username: "fb812708d8d9aeac6f784ba6",
                    credential: "4ulqVF46r6A0jrYl",
                },
                {
                    urls: "turn:standard.relay.metered.ca:80?transport=tcp",
                    username: "fb812708d8d9aeac6f784ba6",
                    credential: "4ulqVF46r6A0jrYl",
                },
                {
                    urls: "turn:standard.relay.metered.ca:443",
                    username: "fb812708d8d9aeac6f784ba6",
                    credential: "4ulqVF46r6A0jrYl",
                },
                {
                    urls: "turns:standard.relay.metered.ca:443?transport=tcp",
                    username: "fb812708d8d9aeac6f784ba6",
                    credential: "4ulqVF46r6A0jrYl",
                },
            ],
        });

        // Prepare to receive video
        pc.addTransceiver('video', { direction: 'recvonly' });
        pc.addTransceiver('audio', { direction: 'recvonly' });

        pc.ontrack = event => {
            console.log("Track received!", event.streams[0]);
            document.getElementById('status').innerText = "Streaming via: " + pc.iceConnectionState;
            document.getElementById('status').style.color = "#0f0";

            const videoEl = document.getElementById('remoteVideo');
            videoEl.srcObject = event.streams[0];

            // Tarayıcıyı zorla oynatmaya başlat
            videoEl.play().catch(e => {
                console.error("Autoplay hatası (Tarayıcı engelledi):", e);
                // Eğer burada hata verirse, videoya 'muted' özelliği ekli olduğundan emin ol.
            });
        };

        // Send candidates as they are gathered (Trickle ICE logic preserved in the JSON blob)
        pc.onicecandidate = event => {
            if (pc.localDescription) {
                const answer = {
                    type: pc.localDescription.type,
                    sdp: pc.localDescription.sdp
                };

                // Update the JSON in the text area continuously as new candidates (like TURN relays) are found
                document.getElementById('answerOutput').value = JSON.stringify(answer);

                if (event.candidate) {
                    // Check if it's a relay candidate (TURN)
                    if (event.candidate.type === 'relay') {
                        console.log("TURN (Relay) candidate found! Connection likely to succeed.");
                    } else {
                        console.log("New candidate found: " + event.candidate.type);
                    }
                } else {
                    console.log("Gathering complete.");
                }
            }
        };

        async function handleOffer() {
            try {
                const offerText = document.getElementById('offerInput').value;
                if (!offerText) return alert("Please paste the offer first!");

                document.getElementById('status').innerText = "Processing Offer...";
                const offer = JSON.parse(offerText);

                await pc.setRemoteDescription(offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                document.getElementById('status').innerText = "Answer Created! Copy below.";

            } catch (e) {
                alert("Error: " + e);
            }
        }
    </script>
</body>
</html>
